- name: Bootstrap host
  hosts: all
  vars:
   new_user: neil
   hostname: arch
   locale: en_GB
   keymap: uk

  tasks:

   - name: pacstrap
     ansible.builtin.shell: |
       yes | pacstrap -K /mnt base \
       linux linux-firmware ansible sudo git openssh grub efibootmgr nano dhcpcd

   - name: gen fstab
     ansible.builtin.shell: |
       genfstab -U /mnt > /mnt/etc/fstab

   - name: set timezone
     ansible.builtin.shell: |
       arch-chroot /mnt ln -sf /usr/share/zoneinfo/europe/london /etc/localtime

   - name: set clock
     ansible.builtin.shell: |
       arch-chroot /mnt hwclock --systohc

   - name: set locale
     ansible.builtin.shell: |
       arch-chroot /mnt sed -i -e 's/#{{locale}}/{{locale}}/' /etc/locale.gen

   - name: gen locale
     ansible.builtin.shell: |
       arch-chroot /mnt locale-gen

   - name: locale conf
     ansible.builtin.template:
      src: files/locale.conf.j2 
      dest: /mnt/etc/locale.conf 

   - name: vconsole conf
     ansible.builtin.template:
      src: files/vconsole.conf.j2 
      dest: /mnt/etc/vconsole.conf 

   - name: set hostname
     ansible.builtin.template:
      src: files/hostname.j2 
      dest: /mnt/etc/hostname 

   - block:
     - name: make initramfs 
       ansible.builtin.shell: |
         arch-chroot /mnt mkinitcpio -p  >/dev/null 2>&1
     ignore_errors: yes

   - name: set grub
     ansible.builtin.shell: |
       arch-chroot /mnt grub-install \
        --target=x86_64-efi --efi-directory=/boot \
        --bootloader-id=grub

   - name: make grub config 
     ansible.builtin.shell: |
       arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
      
